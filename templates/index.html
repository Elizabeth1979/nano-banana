<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçå Nano Banana - AI Image Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçå Nano Banana</h1>
            <p>Multi-Agent AI Image Generator powered by Google Gemini 2.5 Flash Image Preview</p>
        </div>
        
        <div class="content">
            <div class="mode-selector">
                <button id="generateModeBtn" class="mode-btn active" onclick="switchMode('generate')">
                    üé® Generate New
                </button>
                <button id="editModeBtn" class="mode-btn" onclick="switchMode('edit')">
                    ‚úèÔ∏è Edit Image
                </button>
            </div>
            
            <div class="input-section">
                <!-- Image Upload Section (initially hidden) -->
                <div id="uploadSection" class="upload-section" style="display: none;">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon">üìÅ</div>
                            <p>Drag & drop an image here or click to browse</p>
                            <small>Supported formats: PNG, JPG, GIF, WebP (max 16MB)</small>
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview">
                        <button class="remove-btn" onclick="clearUpload()">‚úï Remove</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="prompt" id="promptLabel">Image Description:</label>
                    <textarea id="prompt" placeholder="Describe the image you want to generate... e.g., 'a beautiful sunset over mountains with vibrant colors'"></textarea>
                </div>
                
                <div class="controls">
                    <div class="num-images">
                        <label for="numImages">Number of variations:</label>
                        <input type="number" id="numImages" value="4" min="1" max="8">
                    </div>
                    
                    <button class="generate-btn" onclick="generateImages()">
                        <span class="btn-text" id="generateBtnText">Generate Images</span>
                    </button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3>Generating your images...</h3>
                <p>Creating prompt variations and generating images in parallel</p>
            </div>
            
            <div class="results" id="results">
                <h2>Generated Images</h2>
                <div class="image-grid" id="imageGrid">
                    <!-- Generated images will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'generate';
        let uploadedImage = null;
        
        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.getElementById('generateModeBtn').classList.toggle('active', mode === 'generate');
            document.getElementById('editModeBtn').classList.toggle('active', mode === 'edit');
            
            // Show/hide upload section
            document.getElementById('uploadSection').style.display = mode === 'edit' ? 'block' : 'none';
            
            // Update UI text
            const promptLabel = document.getElementById('promptLabel');
            const promptTextarea = document.getElementById('prompt');
            const generateBtnText = document.getElementById('generateBtnText');
            
            if (mode === 'edit') {
                promptLabel.textContent = 'Editing Instructions:';
                promptTextarea.placeholder = 'Describe how you want to edit this image... e.g., "make it darker", "add a sunset background", "change to watercolor style"';
                generateBtnText.textContent = 'Edit Images';
            } else {
                promptLabel.textContent = 'Image Description:';
                promptTextarea.placeholder = 'Describe the image you want to generate... e.g., "a beautiful sunset over mountains with vibrant colors"';
                generateBtnText.textContent = 'Generate Images';
            }
        }
        
        // Image upload handling
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('imageUpload').click();
        });
        
        document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        
        // Drag and drop handling
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload({target: {files: files}});
            }
        });
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            uploadedImage = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function clearUpload() {
            uploadedImage = null;
            document.getElementById('imageUpload').value = '';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
        }
        
        async function generateImages() {
            const prompt = document.getElementById('prompt').value.trim();
            const numImages = parseInt(document.getElementById('numImages').value);
            
            if (!prompt) {
                alert('Please enter an image description');
                return;
            }
            
            if (currentMode === 'edit' && !uploadedImage) {
                alert('Please upload an image to edit');
                return;
            }
            
            // Show loading state
            document.querySelector('.generate-btn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            // Update loading text based on mode
            const loadingText = document.querySelector('#loading h3');
            loadingText.textContent = currentMode === 'edit' ? 'Editing your image...' : 'Generating your images...';
            
            try {
                let response;
                
                if (currentMode === 'edit' && uploadedImage) {
                    // Form data for file upload
                    const formData = new FormData();
                    formData.append('prompt', prompt);
                    formData.append('num_images', numImages);
                    formData.append('image', uploadedImage);
                    
                    response = await fetch('/generate', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // JSON for text-to-image
                    response = await fetch('/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            num_images: numImages
                        })
                    });
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
                
            } catch (error) {
                console.error('Error:', error);
                const resultsSection = document.getElementById('results');
                const imageGrid = document.getElementById('imageGrid');
                imageGrid.innerHTML = '';
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message error';
                errorMessage.textContent = `Error ${currentMode === 'edit' ? 'editing' : 'generating'} images: ${error.message}`;
                resultsSection.insertBefore(errorMessage, imageGrid);
                document.getElementById('results').style.display = 'block';
            } finally {
                // Hide loading state
                document.querySelector('.generate-btn').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(data) {
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            
            // Add summary message above the grid
            const resultsSection = document.getElementById('results');
            const existingSummary = resultsSection.querySelector('.status-message');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            if (data.successful_count > 0) {
                const successMessage = document.createElement('div');
                successMessage.className = 'status-message success';
                successMessage.textContent = `Successfully generated ${data.successful_count} out of ${data.num_requested} images!`;
                resultsSection.insertBefore(successMessage, imageGrid);
            }
            
            if (data.failed_count > 0) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message error';
                errorMessage.textContent = `${data.failed_count} images failed to generate`;
                resultsSection.insertBefore(errorMessage, imageGrid);
            }
            
            // Display successful images
            data.results.forEach(result => {
                if (result.success) {
                    const imageCard = document.createElement('div');
                    imageCard.className = 'image-card';
                    imageCard.innerHTML = `
                        <img src="/outputs/${result.filename.split('/').pop()}" alt="Generated Image ${result.index + 1}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4='">
                        <div class="image-prompt">${result.prompt}</div>
                    `;
                    imageGrid.appendChild(imageCard);
                } else {
                    const errorCard = document.createElement('div');
                    errorCard.className = 'image-card error';
                    errorCard.innerHTML = `
                        <h4>Image ${result.index + 1} Failed</h4>
                        <p><strong>Prompt:</strong> ${result.prompt}</p>
                        <p><strong>Error:</strong> ${result.error}</p>
                    `;
                    imageGrid.appendChild(errorCard);
                }
            });
            
            document.getElementById('results').style.display = 'block';
        }
        
        // Allow Enter key to generate images
        document.getElementById('prompt').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                generateImages();
            }
        });
    </script>
</body>
</html>